

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
        <title>Justonepixel.com - Case study with RethinkDB Muni's predictions</title>
        
        <meta name="author" content="Michel">

        <!-- Enable responsive viewport -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/bootstrap/css/bootstrap.2.2.2.min.css"/>
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/css/style.css?body=1"/>

        <!-- atom & rss feed -->
        <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
        <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
    </head>

    <body>
    <div class="wrapper container">
    <div class="row">
        <div class="span1 offset1">
            <div class="navbar">
                <ul>
                    <li><a href="/"><img src="/assets/themes/justonepixel/img/home.png" /></a></li>
                    <li><a href="/about.html"><img src="/assets/themes/justonepixel/img/about.png" /></a></li>
                    <li><a href="/contact.html"><img src="/assets/themes/justonepixel/img/contact.png" /></a></li>
                    <li><a href="/archive.html"><img src="/assets/themes/justonepixel/img/archive.png" /></a></li>
                    <li><a href="/search.html"><img src="/assets/themes/justonepixel/img/search.png" /></a></li>
                    <li><a href="https://github.com/neumino"><img src="/assets/themes/justonepixel/img/github.png" /></a></li>
                    <li><a href="http://www.strava.com/athletes/1952902"><img src="/assets/themes/justonepixel/img/strava.png" /></a></li>
                    <li><a href="https://twitter.com/neumino"><img src="/assets/themes/justonepixel/img/twitter.png" /></a></li>
                    <li><a href="https://www.facebook.com/michel.tu"><img src="/assets/themes/justonepixel/img/facebook.png" /></a></li>
                    <li><a href="http://www.linkedin.com/in/tumichel"><img src="/assets/themes/justonepixel/img/linkedin.png" /></a></li>
                    <li><a href="https://plus.google.com/u/0/111745051853861893359/posts"><img src="/assets/themes/justonepixel/img/googleplus.png" /></a></li>
                </ul>
            </div>
        </div>

        <div class="span9">

            <div class="content">
                

<div class="post">
<i class="icon-post"></i>

    <h2>
        <a href="/geek/2013/01/22/muni-prediction" class="title">Case study with RethinkDB Muni's predictions</a>
        <span class="meta_info">posted on 22 January 2013</span>
    </h2>

    
<p><em>Note</em>: RethinkDB has changed the API for the JavaScript driver and these queries are outdated.</p>

<p><a href="http://www.sfmta.com" title="Muni">Muni</a> stands for San Francisco Municipal Transportation Agency and is the agency running all buses in San Francisco. I’m taking the bus every weekday to go to/come back from the Caltrain station.</p>

<p>Muni provides <a href="http://www.sfmta.com/cms/asite/nextmunidata.htm" title="Muni's nextbus api">an api</a> to get at what time the next bus will arrive.
I have noticed that the predictions are not always accurate and sometimes completely off. So I thought it would be nice to quantify these inaccuracies and play with ReQL, <a href="http://www.rethinkdb.com">RethinkDB</a>’s query language.</p>

<p><em>Note: I am working at RethinkDB but this article is just the result of me playing around during a week end.</em></p>

<p>First let’s retrieve some data and store it in the database. I have written a script that pulls data from Muni’s API every 20 seconds and store it in the database.
It is written in CoffeeScript and use node.js with the http and xml2js libraries.
You can read the <a href="https://raw.github.com/neumino/muni/master/pull.coffee">raw file</a> or clone the <a href="https://github.com/neumino/muni">github repository</a></p>

<p>Pulling data for all the stops of the line 48 during one day (on a Thursday) filled my table with 500.000 entries.</p>

<p>Now come the interesting part. I could retrieve all the data in the table and make some operations on top of it using coffee-script/python/ruby, but that would be cheating. RethinkDB aims to be able to run long analytics queries, so I gave it a try.</p>

<p>The documents I have stored in my database have the following format.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"stop_tag"</span><span class="p">:</span><span class="w"> </span><span class="mi">3512</span><span class="p">,</span><span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">stop's</span><span class="w"> </span><span class="err">id</span><span class="w">
    </span><span class="nt">"next_bus_sec"</span><span class="p">:</span><span class="w"> </span><span class="mi">1148</span><span class="p">,</span><span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">The</span><span class="w"> </span><span class="err">next</span><span class="w"> </span><span class="err">bus</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">1148</span><span class="w"> </span><span class="err">seconds</span><span class="w">
    </span><span class="nt">"next_bus_min"</span><span class="p">:</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w">      </span><span class="err">//</span><span class="w"> </span><span class="err">The</span><span class="w"> </span><span class="err">next</span><span class="w"> </span><span class="err">bus</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">19</span><span class="w"> </span><span class="err">minutes</span><span class="w">
    </span><span class="nt">"vehicle"</span><span class="p">:</span><span class="w"> </span><span class="mi">8430</span><span class="p">,</span><span class="w">         </span><span class="err">//</span><span class="w"> </span><span class="err">The</span><span class="w"> </span><span class="err">id</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">next</span><span class="w"> </span><span class="err">vehicle</span><span class="w"> </span><span class="err">coming</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">19</span><span class="w"> </span><span class="err">minutes</span><span class="w">
    </span><span class="nt">"time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1356935060062</span><span class="p">,</span><span class="w">   </span><span class="err">//</span><span class="w"> </span><span class="err">The</span><span class="w"> </span><span class="err">time</span><span class="w"> </span><span class="err">when</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">prediction</span><span class="w"> </span><span class="err">was</span><span class="w"> </span><span class="err">made</span><span class="w">
    </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0003ac31-e903-4ec1-9184-3dfee272fd48"</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">id</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">document</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>If I order my rows by “time” and map the value of next_bus_min. I would get something like that</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[7, 6, 5, 4, 3, 2, 1, 0, 10, 9, 8, 8, 7, 6, 5, 5, 4, 3, 3, 2, 1, 0, ...]
 |              |
 |          The next bus is in 2 minutes
 The next bus is in 7 minutes
</code></pre>
</div>

<p>And here is what I want to retrieve is for each prediction: the prediction minus how long the user did wait.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>How long the user waited
&lt;--------------------&gt;
[7, 6, 5, 4, 3, 2, 1, 0, 10, 9, 8, 8, 7, 6, 5, 5, 4, 3, 3, 2, 1, 0, ...]
 |                    |
 |             Next bus in 0 minute = The bus is here
 |                    
 Next bus will be in 7 minutes
</code></pre>
</div>

<p>To build the query, I used the data explorer because it provides a nice interface to test my query.
I don’t have an extra table with a list of stops available, so I first retrieved all the stops using pluck() and distinct()</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">'muni'</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">).</span><span class="nx">distinct</span><span class="p">().</span><span class="nx">run</span><span class="p">()</span>
</code></pre>
</div>

<p>Now for each stops, I will retrieve the list of predictions we have. 
This can be done with an inner join query and a groupBy. I just went for a simple map.
One think about ReQL is that implicit variable (r.row) cannot be used in case of nested queries, so I have to use anonymous functions (also known as lambda functions in Python) for the next steps.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">'muni'</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">).</span><span class="nx">distinct</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">{</span>
        <span class="na">stop_tag</span><span class="p">:</span> <span class="nx">stop</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">),</span>
        <span class="na">predictions</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">'muni'</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">prediction</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">prediction</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="nx">stop</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">))</span> 
            <span class="p">}).</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'time'</span><span class="p">).</span><span class="nx">streamToArray</span><span class="p">()</span>
    <span class="p">}})</span>
    <span class="p">.</span><span class="nx">run</span><span class="p">()</span>
</code></pre>
</div>

<p>Now that I have for each stop all the predictions, I would like to know how accurate the prediction is. 
I will consider that the time when the bus arrive is the next prediction that show the next bus in 0 minute. So I have to join the inner query with itself. To avoid computing this stream 1+n time (which can be expensive because I use a sort every time), I’m going to use r.let() and store it in memory.</p>

<p>The syntax for r.let() now is</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">r</span><span class="p">.</span><span class="kd">let</span><span class="p">(</span> <span class="p">{</span> <span class="s2">"key"</span><span class="p">:</span> <span class="o">&lt;</span><span class="nx">object</span> <span class="nx">Obj</span> <span class="nx">we</span> <span class="nx">want</span> <span class="nx">to</span> <span class="nx">store</span><span class="o">&gt;</span> <span class="p">},</span> <span class="o">&lt;</span><span class="nx">query</span> <span class="nx">that</span> <span class="nx">uses</span> <span class="nx">Obj</span><span class="o">&gt;</span><span class="p">).</span><span class="nx">run</span><span class="p">()</span> 
</code></pre>
</div>
<p><em>Note: The syntax for r.let() will change on the next release (1.4).</em></p>

<p>The previous query with r.let() looks like that:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">'muni'</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">).</span><span class="nx">distinct</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="na">stop_tag</span><span class="p">:</span> <span class="nx">stop</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">),</span>
            <span class="na">prediction_error</span><span class="p">:</span> 
            <span class="nx">r</span><span class="p">.</span><span class="kd">let</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="na">predictions</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">'muni'</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">prediction</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nx">prediction</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="nx">stop</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">))</span>
                        <span class="p">})</span>
                        <span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'time'</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">streamToArray</span><span class="p">()</span>
                <span class="p">},</span> 
                <span class="nx">r</span><span class="p">.</span><span class="nx">letVar</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">run</span><span class="p">()</span>
</code></pre>
</div>

<p>Now let’s cross the stream with itself and get for each prediction all the times when a bus arrived.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">'muni'</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">).</span><span class="nx">distinct</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
    <span class="na">stop_tag</span><span class="p">:</span> <span class="nx">stop</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">),</span>
    <span class="na">prediction_error</span><span class="p">:</span> 
    <span class="nx">r</span><span class="p">.</span><span class="kd">let</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="na">predictions</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">'muni'</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">filter</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">prediction</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">prediction</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="nx">stop</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">))</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'time'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">streamToArray</span><span class="p">()</span>
        <span class="p">},</span> 
        <span class="nx">r</span><span class="p">.</span><span class="nx">letVar</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">prediction</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">letVar</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">next_prediction</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">next_prediction</span><span class="p">(</span><span class="s1">'next_bus_min'</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">and</span><span class="p">(</span><span class="nx">prediction</span><span class="p">(</span><span class="s1">'time'</span><span class="p">).</span><span class="nx">le</span><span class="p">(</span><span class="nx">next_prediction</span><span class="p">(</span><span class="s1">'time'</span><span class="p">)))</span>
                <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">)</span>
    <span class="p">}})</span>
<span class="p">.</span><span class="nx">run</span><span class="p">()</span>
</code></pre>
</div>

<p>Now that I have all the data I need, I just have to do some math to get the error.
So among all the prediction that we retrieve in the inner query, we just need the first one (the next time the bus arrive). Using nth(0) could break in case a bus never comes (calling .nth(0) on an empty array). A solution to make sure that nth(0) is not going to break is to use r.branch (which is the syntax for “if”). I was lazy so I just used a trick adding an element that is going to yield a zero error.
Then we can safely compute the error.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">'muni'</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">).</span><span class="nx">distinct</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="na">stop_tag</span><span class="p">:</span> <span class="nx">stop</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">),</span>
            <span class="na">prediction_error</span><span class="p">:</span> 
            <span class="nx">r</span><span class="p">.</span><span class="kd">let</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="na">predictions</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">'muni'</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">prediction</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nx">prediction</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="nx">stop</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">))</span>
                        <span class="p">})</span>
                        <span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'time'</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">streamToArray</span><span class="p">()</span>
                <span class="p">},</span> 
                <span class="nx">r</span><span class="p">.</span><span class="nx">letVar</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">prediction</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">letVar</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">next_prediction</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">next_prediction</span><span class="p">(</span><span class="s1">'next_bus_min'</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">and</span><span class="p">(</span><span class="nx">prediction</span><span class="p">(</span><span class="s1">'time'</span><span class="p">).</span><span class="nx">le</span><span class="p">(</span><span class="nx">next_prediction</span><span class="p">(</span><span class="s1">'time'</span><span class="p">)))</span>
                    <span class="p">})</span>
                    <span class="p">.</span><span class="nx">union</span><span class="p">([{</span><span class="na">time</span><span class="p">:</span> <span class="nx">prediction</span><span class="p">(</span><span class="s1">'time'</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">prediction</span><span class="p">(</span><span class="s1">'next_bus_min'</span><span class="p">).</span><span class="nx">mul</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">))}])</span>
                    <span class="p">.</span><span class="nx">nth</span><span class="p">(</span><span class="mi">0</span><span class="p">)(</span><span class="s1">'time'</span><span class="p">).</span><span class="nx">sub</span><span class="p">(</span><span class="nx">prediction</span><span class="p">(</span><span class="s1">'time'</span><span class="p">)).</span><span class="nx">div</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">).</span><span class="nx">sub</span><span class="p">(</span><span class="nx">prediction</span><span class="p">(</span><span class="s1">'next_bus_min'</span><span class="p">))</span>
                <span class="p">})</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">run</span><span class="p">()</span>
</code></pre>
</div>

<p>So the error now looks like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span>
    <span class="s2">"stop_tag"</span><span class="err">:</span><span class="mi">6744</span><span class="p">,</span>
    <span class="s2">"prediction_error"</span><span class="err">:</span><span class="p">[</span>
        <span class="o">-</span><span class="mf">0.001300000000000523</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">0.3384333333333327</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">0.665916666666666</span><span class="p">,</span>
        <span class="mf">0.00016666666666687036</span><span class="p">,</span>
        <span class="cm">/* more... */</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The following query compute the norm 1 error.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">'muni'</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">).</span><span class="nx">distinct</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="na">stop_tag</span><span class="p">:</span> <span class="nx">stop</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">),</span>
            <span class="na">prediction_error</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="kd">let</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="na">predictions</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">'muni'</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">prediction</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">prediction</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="nx">stop</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">))</span>
                    <span class="p">})</span>
                    <span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'time'</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">streamToArray</span><span class="p">()</span>
                <span class="p">},</span> 
                <span class="nx">r</span><span class="p">.</span><span class="nx">letVar</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">prediction</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">letVar</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">next_prediction</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">next_prediction</span><span class="p">(</span><span class="s1">'next_bus_min'</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="p">.</span><span class="nx">and</span><span class="p">(</span><span class="nx">prediction</span><span class="p">(</span><span class="s1">'time'</span><span class="p">).</span><span class="nx">le</span><span class="p">(</span><span class="nx">next_prediction</span><span class="p">(</span><span class="s1">'time'</span><span class="p">)))</span>
                    <span class="p">})</span>
                    <span class="p">.</span><span class="nx">union</span><span class="p">([{</span><span class="na">time</span><span class="p">:</span> <span class="nx">prediction</span><span class="p">(</span><span class="s1">'time'</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">prediction</span><span class="p">(</span><span class="s1">'next_bus_min'</span><span class="p">).</span><span class="nx">mul</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">))}])</span>
                    <span class="p">.</span><span class="nx">nth</span><span class="p">(</span><span class="mi">0</span><span class="p">)(</span><span class="s1">'time'</span><span class="p">).</span><span class="nx">sub</span><span class="p">(</span><span class="nx">prediction</span><span class="p">(</span><span class="s1">'time'</span><span class="p">)).</span><span class="nx">div</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">).</span><span class="nx">sub</span><span class="p">(</span><span class="nx">prediction</span><span class="p">(</span><span class="s1">'next_bus_min'</span><span class="p">))</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">branch</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">lt</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nx">error</span><span class="p">.</span><span class="nx">mul</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nx">error</span><span class="p">)</span> <span class="p">})</span>
                <span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">acc</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">acc</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">val</span><span class="p">)})</span>
                <span class="p">.</span><span class="nx">div</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">letVar</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">count</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">run</span><span class="p">()</span>
</code></pre>
</div>

<p>Since I am looking at the data in term of user experience, I am also (and mostly) interested in the worst case. So here is how I got the maximum error:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">'muni'</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">).</span><span class="nx">distinct</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="na">stop_tag</span><span class="p">:</span> <span class="nx">stop</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">),</span>
            <span class="na">prediction_error</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="kd">let</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="na">predictions</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">'muni'</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">prediction</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nx">prediction</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="nx">stop</span><span class="p">(</span><span class="s1">'stop_tag'</span><span class="p">))</span>
                        <span class="p">})</span>
                        <span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'time'</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">streamToArray</span><span class="p">()</span>
                <span class="p">},</span> 
                <span class="nx">r</span><span class="p">.</span><span class="nx">letVar</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">prediction</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">letVar</span><span class="p">(</span><span class="s1">'predictions'</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">next_prediction</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">next_prediction</span><span class="p">(</span><span class="s1">'next_bus_min'</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="p">.</span><span class="nx">and</span><span class="p">(</span><span class="nx">prediction</span><span class="p">(</span><span class="s1">'time'</span><span class="p">).</span><span class="nx">le</span><span class="p">(</span><span class="nx">next_prediction</span><span class="p">(</span><span class="s1">'time'</span><span class="p">)))</span>
                    <span class="p">})</span>
                    <span class="p">.</span><span class="nx">union</span><span class="p">([{</span><span class="na">time</span><span class="p">:</span> <span class="nx">prediction</span><span class="p">(</span><span class="s1">'time'</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">prediction</span><span class="p">(</span><span class="s1">'next_bus_min'</span><span class="p">).</span><span class="nx">mul</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">))}])</span>
                    <span class="p">.</span><span class="nx">nth</span><span class="p">(</span><span class="mi">0</span><span class="p">)(</span><span class="s1">'time'</span><span class="p">).</span><span class="nx">sub</span><span class="p">(</span><span class="nx">prediction</span><span class="p">(</span><span class="s1">'time'</span><span class="p">)).</span><span class="nx">div</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">).</span><span class="nx">sub</span><span class="p">(</span><span class="nx">prediction</span><span class="p">(</span><span class="s1">'next_bus_min'</span><span class="p">))</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">acc</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span> 
                    <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">branch</span><span class="p">(</span><span class="nx">val</span><span class="p">.</span><span class="nx">gt</span><span class="p">(</span><span class="nx">acc</span><span class="p">),</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">acc</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">run</span><span class="p">()</span>
</code></pre>
</div>

<p>The results look like that:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span>
    <span class="s2">"stop_tag"</span><span class="err">:</span> <span class="mi">3248</span><span class="p">,</span>
    <span class="s2">"prediction_error"</span><span class="err">:</span> <span class="mf">35.01116666666667</span>
<span class="p">},</span>
<span class="p">{</span>
    <span class="s2">"stop_tag"</span><span class="p">:</span> <span class="mi">3249</span><span class="p">,</span>
    <span class="s2">"prediction_error"</span><span class="p">:</span> <span class="mf">6.006866666666667</span>
<span class="p">},</span>
<span class="p">{</span>
    <span class="s2">"stop_tag"</span><span class="p">:</span> <span class="mi">3250</span><span class="p">,</span>
    <span class="s2">"prediction_error"</span><span class="p">:</span> <span class="mf">35.333483333333334</span>
<span class="p">},</span>
<span class="p">{</span>
    <span class="s2">"stop_tag"</span><span class="p">:</span> <span class="mi">3251</span><span class="p">,</span>
    <span class="s2">"prediction_error"</span><span class="p">:</span> <span class="mf">35.33631666666666</span>
<span class="p">},</span>
<span class="p">{</span>
    <span class="s2">"stop_tag"</span><span class="p">:</span> <span class="mi">3252</span><span class="p">,</span>
    <span class="s2">"prediction_error"</span><span class="p">:</span> <span class="mf">6.002116666666666</span>
<span class="p">},</span>
<span class="p">{</span>
    <span class="s2">"stop_tag"</span><span class="p">:</span> <span class="mi">3304</span><span class="p">,</span>
    <span class="s2">"prediction_error"</span><span class="p">:</span> <span class="mf">5.670216666666667</span>
<span class="p">},</span>
<span class="p">{</span>
    <span class="s2">"stop_tag"</span><span class="p">:</span> <span class="mi">3305</span><span class="p">,</span>
    <span class="s2">"prediction_error"</span><span class="p">:</span> <span class="mf">34.669200000000004</span>
<span class="p">},</span>
<span class="p">{</span>
    <span class="s2">"stop_tag"</span><span class="p">:</span> <span class="mi">3306</span><span class="p">,</span>
    <span class="s2">"prediction_error"</span><span class="p">:</span> <span class="mf">6.00385</span>
<span class="p">},</span>
<span class="p">{</span>
    <span class="s2">"stop_tag"</span><span class="p">:</span> <span class="mi">3411</span><span class="p">,</span>
    <span class="s2">"prediction_error"</span><span class="p">:</span> <span class="mf">87.99973333333334</span>
<span class="p">},</span>
<span class="p">{</span>
    <span class="s2">"stop_tag"</span><span class="p">:</span> <span class="mi">3424</span><span class="p">,</span>
    <span class="s2">"prediction_error"</span><span class="p">:</span> <span class="mf">16.666383333333332</span>
<span class="p">},{</span>
    <span class="s2">"stop_tag"</span><span class="p">:</span> <span class="mi">3432</span><span class="p">,</span>
    <span class="s2">"prediction_error"</span><span class="p">:</span> <span class="mf">87.0006</span>
<span class="p">}</span>
<span class="p">...</span>
</code></pre>
</div>

<p>So Muni’s prediction are quite aweful. I’ve tried to check for predictions with a bus coming at 1 and 0 minutes, but that didn’t really change the results.
I have seen this thing happening during the evening and from my personal experience, it is because the system that makes the predictions does not know when a bus is going to the garage until it does go there.</p>

<p>Back to the technical part, it was pretty cool to use the data explorer to build an analytic query without having to write a script myself.
The javascript driver doesn’t always return user-friendly errors which is not really cool, but that should be fix on the next release with the new protobuf specs.</p>


    
    <ul class="tag_box inline">
        <li><i class="icon-folder-open"></i></li>
        
        


  
     
    	<li><a href="/categories.html#Geek-ref">
    		Geek <span>43</span>
    	</a></li>
    
  


    </ul>
      

    
    <ul class="tag_box inline">
        <li><i class="icon-tags"></i></li>
        
        


  
     
    	<li><a href="/tags.html#rethinkdb-ref">rethinkdb <span>21</span></a></li>
     
    	<li><a href="/tags.html#mapreduce-ref">mapreduce <span>1</span></a></li>
     
    	<li><a href="/tags.html#muni-ref">muni <span>1</span></a></li>
     
    	<li><a href="/tags.html#bus-ref">bus <span>1</span></a></li>
    
  



    </ul>
      

    
    <hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog.justonepixel.com -->
<ins class="adsbygoogle"
     style="display:inline-block;width:468px;height:60px"
     data-ad-client="ca-pub-5366199723595534"
     data-ad-slot="2620298801"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <hr>
    <div class="pagination">
        <ul>
            
            <li class="prev disabled"><a>&larr; Previous</a></li>
            
            <li><a href="/archive.html">Archive</a></li>
            
            <li class="next"><a href="/geek/2013/02/09/rethinkdb-on-archlinux-tam" title="Building RethinkDB from source on Archlinux">Next &rarr;</a></li>
            
        </ul>
    </div>
    <hr>
</div>


            </div>

            <footer>
                <p>Michel Tu
                &mdash;
                <a href="mailto:michel@justonepixel.com">michel@justonepixel.com</a>
                &mdash;
                <a href="http://blog.justonepixel.com">http://blog.justonepixel.com</a></p>
            </footer>

        </div>
    </div>
    </div>
    <noscript id="deferred-styles">
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/bootstrap/css/bootstrap.2.2.2.min.css"/>
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/css/style.css?body=1"/>
    </noscript>
    <script>
      var loadDeferredStyles = function() {
        var addStylesNode = document.getElementById("deferred-styles");
        var replacement = document.createElement("div");
        replacement.innerHTML = addStylesNode.textContent;
        document.body.appendChild(replacement)
        addStylesNode.parentElement.removeChild(addStylesNode);
      };
      var raf = requestAnimationFrame || mozRequestAnimationFrame ||
          webkitRequestAnimationFrame || msRequestAnimationFrame;
      if (raf) raf(function() { window.setTimeout(loadDeferredStyles, 0); });
      else window.addEventListener('load', loadDeferredStyles);
    </script>
		
    </body>
</html>

