

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
        <title>Justonepixel.com - RethinkDB and CoreOS: Navigating Digital Ocean Together</title>
        
        <meta name="author" content="Michel">

        <!-- Enable responsive viewport -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/bootstrap/css/bootstrap.2.2.2.min.css"/>
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/css/style.css?body=1"/>

        <!-- atom & rss feed -->
        <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
        <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
    </head>

    <body>
    <div class="wrapper container">
    <div class="row">
        <div class="span1 offset1">
            <div class="navbar">
                <ul>
                    <li><a href="/"><img src="/assets/themes/justonepixel/img/home.png" /></a></li>
                    <li><a href="/about.html"><img src="/assets/themes/justonepixel/img/about.png" /></a></li>
                    <li><a href="/contact.html"><img src="/assets/themes/justonepixel/img/contact.png" /></a></li>
                    <li><a href="/archive.html"><img src="/assets/themes/justonepixel/img/archive.png" /></a></li>
                    <li><a href="/search.html"><img src="/assets/themes/justonepixel/img/search.png" /></a></li>
                    <li><a href="https://github.com/neumino"><img src="/assets/themes/justonepixel/img/github.png" /></a></li>
                    <li><a href="http://www.strava.com/athletes/1952902"><img src="/assets/themes/justonepixel/img/strava.png" /></a></li>
                    <li><a href="https://twitter.com/neumino"><img src="/assets/themes/justonepixel/img/twitter.png" /></a></li>
                    <li><a href="https://www.facebook.com/michel.tu"><img src="/assets/themes/justonepixel/img/facebook.png" /></a></li>
                    <li><a href="http://www.linkedin.com/in/tumichel"><img src="/assets/themes/justonepixel/img/linkedin.png" /></a></li>
                    <li><a href="https://plus.google.com/u/0/111745051853861893359/posts"><img src="/assets/themes/justonepixel/img/googleplus.png" /></a></li>
                </ul>
            </div>
        </div>

        <div class="span9">

            <div class="content">
                

<div class="post">
<i class="icon-post"></i>

    <h2>
        <a href="/geek/2014/10/03/rethinkdb-and-coreos" class="title">RethinkDB and CoreOS: Navigating Digital Ocean Together</a>
        <span class="meta_info">posted on 03 October 2014</span>
    </h2>

    
<p><em>A new generation of databases are now sailing on new seas such as Digital Ocean,
transported in Docker containers, and steered by CoreOS.</em></p>

<p><a href="https://coreos.com">CoreOS</a> is a terrific tool to deploy applications on multiple
servers. However, running a <a href="http://rethinkdb.com">RethinkDB</a> cluster on CoreOS is a bit more
complicated than running multiple Nginx servers with a load balancer since a RethinkDB
instance must be given at least one server to join. This article illustrates one way,
hopefully the right way, to do it on <a href="https://www.digitalocean.com/?refcode=51c7697c943e">Digital Ocean</a>.</p>

<p>First, set up a fleet (or sub-fleet) of CoreOS machines; in this example, we will
suppose that we are building a 6-server RethinkDB cluster. If you have never done it
before, begin by getting a discovery <code class="highlighter-rouge">token</code> on
<a href="https://discovery.etcd.io/new">https://discovery.etcd.io/new</a>.</p>

<p>Then boot a few CoreOS instances with the following <code class="highlighter-rouge">cloud-config</code> file and your
ssh keys. Make sure that you enable private networking on Digital Ocean as RethinkDB
does not provide encryption/security for cluster traffic yet.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#cloud-config

coreos:
  etcd:
    discovery: https://discovery.etcd.io/&lt;token&gt;
    addr: $private_ipv4:4001
    peer-addr: $private_ipv4:7001
  fleet:
    public-ip: $private_ipv4   # used for fleetctl ssh command
    metadata: group=rethinkdb
  units:
    - name: etcd.service
      command: start
    - name: fleet.service
      command: start
</code></pre>
</div>

<p>Note that these machines will be tagged with the metadata <code class="highlighter-rouge">group=rethinkdb</code>. I
personally appreciate being able to group my servers depending on
what their responsibilities are (or will be).</p>

<p>To create a RethinkDB cluster, we need to start the instances with the argument
<code class="highlighter-rouge">--join host:port</code> where another instance of RethinkDB will be running.
We will first create a discovery service where CoreOS servers will register their
IP in <a href="https://coreos.com/using-coreos/etcd/">etcd</a> using
<a href="https://coreos.com/docs/etcdctl/">etcdctl</a>; we will force RethinkDB to run
on these servers and provide them with all the IP addresses of the servers running the
discovery service.</p>

<p>First, let’s create a file <code class="highlighter-rouge">rethinkdb-discovery@.service</code> on one of your servers with the
following content:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[Unit]
Description=Announce RethinkDB@%i service

[Service]
EnvironmentFile=/etc/environment
ExecStart=/bin/sh -c "while true; do etcdctl set /announce/services/rethinkdb%i ${COREOS_PRIVATE_IPV4} --ttl 60; sleep 45; done"
ExecStop=/usr/bin/etcdctl rm /announce/services/rethinkdb%i

[X-Fleet]
X-Conflicts=rethinkdb-discovery@*.service
MachineMetadata=group=rethinkdb
</code></pre>
</div>

<p>Then load the service with:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>fleetctl submit rethinkdb-discovery@.service
</code></pre>
</div>

<p>Finally, start it with:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>fleetctl start rethinkdb-discovery@{1..6}.service
</code></pre>
</div>

<p>Now create the service for RethinkDB:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[Unit]
Description=RethinkDB@%i service
After=docker.service
BindsTo=rethinkdb-discovery@%i.service

[Service]
EnvironmentFile=/etc/environment
TimeoutStartSec=0
ExecStartPre=-/usr/bin/docker kill rethinkdb%i
ExecStartPre=-/usr/bin/docker rm rethinkdb%i
ExecStartPre=-/usr/bin/mkdir -p /home/core/docker-volumes/rethinkdb
ExecStartPre=/usr/bin/docker pull dockerfile/rethinkdb
ExecStart=/bin/sh -c '/usr/bin/docker run --name rethinkdb%i   \
    -p ${COREOS_PRIVATE_IPV4}:8080:8080                        \
    -p ${COREOS_PRIVATE_IPV4}:28015:28015                      \
    -p ${COREOS_PRIVATE_IPV4}:29015:29015                      \
    -v /home/core/docker-volumes/rethinkdb/:/data/             \
    dockerfile/rethinkdb rethinkdb --bind all                  \
    --canonical-address ${COREOS_PRIVATE_IPV4}                 \
    $(/usr/bin/etcdctl ls /announce/services |                 \
        xargs -I {} /usr/bin/etcdctl get {} |                  \
        sed s/^/"--join "/ | sed s/$/":29015"/ |               \
        tr "\n" " ")'

ExecStop=/usr/bin/docker stop rethinkdb%i

[X-Fleet]
MachineMetadata=group=rethinkdb
X-ConditionMachineOf=rethinkdb-discovery@%i.service
</code></pre>
</div>

<p>The service is first going to fetch data from <code class="highlighter-rouge">etcd</code> and then start a
<a href="https://docker.com">Docker</a> container with RethinkDB with the <code class="highlighter-rouge">--join</code> argument.</p>

<p>Note: Because you are running RethinkDB inside a container, you must provide
the argument <code class="highlighter-rouge">canonical-address</code> or other instances will try to connect to the
<a href="https://github.com/rethinkdb/rethinkdb/issues/486">wrong IP address</a>.</p>

<p>Run:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>fleetctl start rethinkdb@{1..6}.service
</code></pre>
</div>

<p>And it’s done! You now have a cluster of six machines running RethinkDB.</p>

<p>When RethinkDB provides auto-failover, in the event of a server failure, if you happen to have
an extra CoreOS server, CoreOS will restart another RethinkDB instance and RethinkDB will
automatically re-elect a master/backfill to prepare another
replica without requiring any work on your end.
Heavy refactoring of the clustering is being done right now, so hopefully
this feature should ship soon (~2 months?).</p>

<p>Two things to finish this article:</p>

<ol>
  <li>Thanks to <a href="https://github.com/atnnn">@atnnn</a> for helping me with some bash issues
and <a href="https://twitter.com/jessskuo">Jessie</a> for proofreading my Frenglish.</li>
  <li>Questions? Suggestions? Ping me on Twitter: <a href="https://twitter.com/neumino">@neumino</a>.</li>
</ol>

<p><em>Edit</em>: dividuum on Hacker News pointed out that the private networking on Digital Ocean
was not restricting other droplets from connecting to the cluster. I will follow up
with another post to run some iptables commands to make sure that the cluster is safe.</p>


    
    <ul class="tag_box inline">
        <li><i class="icon-folder-open"></i></li>
        
        


  
     
    	<li><a href="/categories.html#Geek-ref">
    		Geek <span>43</span>
    	</a></li>
    
  


    </ul>
      

    
    <ul class="tag_box inline">
        <li><i class="icon-tags"></i></li>
        
        


  
     
    	<li><a href="/tags.html#rethinkdb-ref">rethinkdb <span>21</span></a></li>
     
    	<li><a href="/tags.html#docker-ref">docker <span>2</span></a></li>
     
    	<li><a href="/tags.html#coreos-ref">coreos <span>1</span></a></li>
     
    	<li><a href="/tags.html#digitalocean-ref">digitalocean <span>1</span></a></li>
    
  



    </ul>
      

    
    <hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog.justonepixel.com -->
<ins class="adsbygoogle"
     style="display:inline-block;width:468px;height:60px"
     data-ad-client="ca-pub-5366199723595534"
     data-ad-slot="2620298801"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <hr>
    <div class="pagination">
        <ul>
            
            <li class="prev"><a href="/geek/2014/07/14/firefox-os-docker" title="Docker container for Firefox OS">&larr; Previous</a></li>
            
            <li><a href="/archive.html">Archive</a></li>
            
            <li class="next"><a href="/geek/2014/11/12/thinky-1.15.1" title="Thinky 1.15.1 and a sneak peek at the future">Next &rarr;</a></li>
            
        </ul>
    </div>
    <hr>
</div>


            </div>

            <footer>
                <p>Michel Tu
                &mdash;
                <a href="mailto:michel@justonepixel.com">michel@justonepixel.com</a>
                &mdash;
                <a href="http://blog.justonepixel.com">http://blog.justonepixel.com</a></p>
            </footer>

        </div>
    </div>
    </div>
    <noscript id="deferred-styles">
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/bootstrap/css/bootstrap.2.2.2.min.css"/>
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/css/style.css?body=1"/>
    </noscript>
    <script>
      var loadDeferredStyles = function() {
        var addStylesNode = document.getElementById("deferred-styles");
        var replacement = document.createElement("div");
        replacement.innerHTML = addStylesNode.textContent;
        document.body.appendChild(replacement)
        addStylesNode.parentElement.removeChild(addStylesNode);
      };
      var raf = requestAnimationFrame || mozRequestAnimationFrame ||
          webkitRequestAnimationFrame || msRequestAnimationFrame;
      if (raf) raf(function() { window.setTimeout(loadDeferredStyles, 0); });
      else window.addEventListener('load', loadDeferredStyles);
    </script>
		
    </body>
</html>

