

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
        <title>Justonepixel.com - Rethinkdbdash 1.16: Node.js streams, implicit run and more</title>
        
        <meta name="author" content="Michel">

        <!-- Enable responsive viewport -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/bootstrap/css/bootstrap.2.2.2.min.css"/>
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/css/style.css?body=1"/>

        <!-- atom & rss feed -->
        <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
        <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
    </head>

    <body>
    <div class="wrapper container">
    <div class="row">
        <div class="span1 offset1">
            <div class="navbar">
                <ul>
                    <li><a href="/"><img src="/assets/themes/justonepixel/img/home.png" /></a></li>
                    <li><a href="/about.html"><img src="/assets/themes/justonepixel/img/about.png" /></a></li>
                    <li><a href="/contact.html"><img src="/assets/themes/justonepixel/img/contact.png" /></a></li>
                    <li><a href="/archive.html"><img src="/assets/themes/justonepixel/img/archive.png" /></a></li>
                    <li><a href="/search.html"><img src="/assets/themes/justonepixel/img/search.png" /></a></li>
                    <li><a href="https://github.com/neumino"><img src="/assets/themes/justonepixel/img/github.png" /></a></li>
                    <li><a href="http://www.strava.com/athletes/1952902"><img src="/assets/themes/justonepixel/img/strava.png" /></a></li>
                    <li><a href="https://twitter.com/neumino"><img src="/assets/themes/justonepixel/img/twitter.png" /></a></li>
                    <li><a href="https://www.facebook.com/michel.tu"><img src="/assets/themes/justonepixel/img/facebook.png" /></a></li>
                    <li><a href="http://www.linkedin.com/in/tumichel"><img src="/assets/themes/justonepixel/img/linkedin.png" /></a></li>
                    <li><a href="https://plus.google.com/u/0/111745051853861893359/posts"><img src="/assets/themes/justonepixel/img/googleplus.png" /></a></li>
                </ul>
            </div>
        </div>

        <div class="span9">

            <div class="content">
                

<div class="post">
<i class="icon-post"></i>

    <h2>
        <a href="/geek/2015/01/31/rethinkdbdash-nodejs-streams-and-implicit-run" class="title">Rethinkdbdash 1.16: Node.js streams, implicit run and more</a>
        <span class="meta_info">posted on 31 January 2015</span>
    </h2>

    
<p><em>Note</em>: Never heard of RethinkDB? You may want to read about <a href="http://rethinkdb.com/blog/realtime-web/">where it’s going</a>.</p>

<p><a href="https://github.com/neumino/rethinkdbdash">Rethinkdbdash</a> is an experimental
yet stable Node.js driver for <a href="http://rethinkdb.com">RethinkDB</a>. It started as a playground to test
promises and connection pools, and still strives today to provide a better
experience for developers.</p>

<p>A new version just got released today, and besides an update to support the new 
<a href="http://www.rethinkdb.com/blog/1.16-release/">RethinkDB 1.16</a> commands,
it comes with a few new features inspired from
<a href="https://github.com/jonathanong">@jonathanong</a>’s writing about an
<a href="https://github.com/jonathanong/ideal-database-client">ideal-database-client</a>.</p>

<p>This blog post aims to describe the main differences between rethinkdbdash
and the official driver.</p>

<h3 id="support-for-nodejs-streams">Support for Node.js streams</h3>

<p>One of the new feature in rethinkdbdash is the support for <a href="http://nodejs.org/api/stream.html">Node.js streams</a>.
You can retrieve a stream with the synchronous method <code class="highlighter-rouge">toStream</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">// Create a transform stream that will convert data to a string</span>
<span class="kd">var</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'stream'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">stringifier</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">Transform</span><span class="p">();</span>
<span class="nx">stringifier</span><span class="p">.</span><span class="nx">_writableState</span><span class="p">.</span><span class="nx">objectMode</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nx">stringifier</span><span class="p">.</span><span class="nx">_transform</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">);</span>
  <span class="nx">done</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// Create a writable stream</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="s1">'result.txt'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'rethinkdbdash'</span><span class="p">)();</span>
<span class="c1">// Pipe the data to the file through stringifier</span>
<span class="nx">r</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s2">"data"</span><span class="p">).</span><span class="nx">toStream</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">stringifier</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
</code></pre>
</div>

<h3 id="optional-run">Optional run</h3>

<p>ReQL is composed of chainable methods, requiring the developer to call the <code class="highlighter-rouge">run</code>
command at the end when the query is complete and ready to be sent to the server.
By implementing <code class="highlighter-rouge">then</code> and <code class="highlighter-rouge">catch</code> as shortcuts for <code class="highlighter-rouge">run().then</code> and <code class="highlighter-rouge">run().catch</code>,
any query will be executed when called with <code class="highlighter-rouge">yield</code> without the need to call <code class="highlighter-rouge">run</code>.</p>

<p>You can now write queries like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">bluebird</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bluebird'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'rethinkdbdash'</span><span class="p">)();</span>
<span class="nx">bluebird</span><span class="p">.</span><span class="nx">coroutine</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">r</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s2">"users"</span><span class="p">).</span><span class="nx">insert</span><span class="p">({</span><span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s2">"Michel"</span><span class="p">,</span> <span class="na">age</span><span class="p">:</span> <span class="mi">28</span><span class="p">});</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">inserted</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="nx">result</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">r</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s2">"users"</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s2">"Michel"</span><span class="p">,</span> <span class="na">age</span><span class="p">:</span> <span class="mi">28</span><span class="p">});</span>

    <span class="nx">result</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">r</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s2">"users"</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">update</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="s2">"John"</span><span class="p">});</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">replaced</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="nx">result</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">r</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s2">"users"</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s2">"John"</span><span class="p">,</span> <span class="na">age</span><span class="p">:</span> <span class="mi">28</span><span class="p">});</span>

    <span class="nx">result</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">r</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s2">"users"</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span> <span class="na">isAdult</span><span class="p">:</span> <span class="nx">user</span><span class="p">(</span><span class="s2">"age"</span><span class="p">).</span><span class="nx">gt</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">replaced</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="nx">result</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">r</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s2">"users"</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s2">"John"</span><span class="p">,</span> <span class="na">age</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span> <span class="na">isAdult</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<h3 id="a-single-point-of-failure">A single point of failure</h3>

<p>Rethinkdbdash has been shipped with a connection pool since its first version. This
connection pool is managed by the driver itself, and users do not have to create or manage
connections themselves. This has two purposes:</p>

<ul>
  <li>Remove repetitive code.</li>
  <li>Provide a unique point of failure. Consider for example this snippet:</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">handleError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">error</span><span class="err">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">error</span><span class="p">));</span>
<span class="p">};</span>

<span class="nx">r</span><span class="p">.</span><span class="nx">connect</span><span class="p">().</span><span class="nx">bind</span><span class="p">({}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_connection</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="nx">handleError</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s2">"users"</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s2">"orphee@gmail.com"</span><span class="p">).</span><span class="nx">run</span><span class="p">()</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">user</span><span class="p">));</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_connection</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_connection</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="nx">handleError</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">error</span><span class="p">(</span><span class="nx">handleError</span><span class="p">);</span>
</code></pre>
</div>

<p>The problem in this code is that the connection can emit an error at any time, meaning
that you have multiple point of failures (the connection and the query itself). 
In the end, depending on your case, you may have to deal with race conditions. Typically here,
<code class="highlighter-rouge">handleError</code> may be called twice.</p>

<p>With rethinkdbdash, network errors are caught by the driver and bubbled to
the relevant queries. Compare the previous code with:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">r</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s2">"users"</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s2">"orphee@gmail.com"</span><span class="p">).</span><span class="nx">run</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">user</span><span class="p">));</span>
<span class="p">}).</span><span class="nx">error</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Catch error returned by the driver</span>
    <span class="c1">// Catch network errors</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">error</span><span class="err">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">error</span><span class="p">));</span>
<span class="p">});</span>
</code></pre>
</div>

<h3 id="like-what-you-read">Like what you read?</h3>
<p>Give it a spin:</p>

<ul>
  <li><a href="http://www.rethinkdb.com/docs/install/">Install</a> RethinkDB</li>
  <li>Install rethinkdbdash with <code class="highlighter-rouge">npm install rethinkdbdash</code></li>
  <li>Checkout the <a href="https://github.com/neumino/rethinkdbdash-examples">examples</a></li>
  <li>Questions? Feedback? Shoot me a mail at <a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#111;&#114;&#112;&#104;&#101;&#101;&#064;&#103;&#109;&#097;&#105;&#108;&#046;&#099;&#111;&#109;">&#111;&#114;&#112;&#104;&#101;&#101;&#064;&#103;&#109;&#097;&#105;&#108;&#046;&#099;&#111;&#109;</a>
or ping me on Twitter <a href="https://twitter.com/neumino">@neumino</a></li>
</ul>

<p><em>Note about streams</em>: <code class="highlighter-rouge">null</code> values are currently silently dropped from streams
as in <code class="highlighter-rouge">objectMode</code>, a <code class="highlighter-rouge">null</code> value means the end of the stream.</p>

<p><em>Note</em>: The <code class="highlighter-rouge">toStream</code> command was added in rethinkdbdash 1.16.4. The argument <code class="highlighter-rouge"><span class="p">{</span><span class="err">stream:</span><span class="w"> </span><span class="err">true</span><span class="p">}</span></code> has
been deprecated.</p>


    
    <ul class="tag_box inline">
        <li><i class="icon-folder-open"></i></li>
        
        


  
     
    	<li><a href="/categories.html#Geek-ref">
    		Geek <span>43</span>
    	</a></li>
    
  


    </ul>
      

    
    <ul class="tag_box inline">
        <li><i class="icon-tags"></i></li>
        
        


  
     
    	<li><a href="/tags.html#rethinkdbdash-ref">rethinkdbdash <span>5</span></a></li>
     
    	<li><a href="/tags.html#rethinkdb-ref">rethinkdb <span>21</span></a></li>
     
    	<li><a href="/tags.html#driver-ref">driver <span>1</span></a></li>
     
    	<li><a href="/tags.html#nodejs-ref">nodejs <span>7</span></a></li>
     
    	<li><a href="/tags.html#iojs-ref">iojs <span>3</span></a></li>
    
  



    </ul>
      

    
    <hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog.justonepixel.com -->
<ins class="adsbygoogle"
     style="display:inline-block;width:468px;height:60px"
     data-ad-client="ca-pub-5366199723595534"
     data-ad-slot="2620298801"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <hr>
    <div class="pagination">
        <ul>
            
            <li class="prev"><a href="/geek/2014/12/26/the-legend-of-korra" title="The Legend of Korra - a damn good cartoon.">&larr; Previous</a></li>
            
            <li><a href="/archive.html">Archive</a></li>
            
            <li class="next"><a href="/geek/2015/02/04/replicate-reql-in-your-classes" title="Replicate ReQL API in your own classes">Next &rarr;</a></li>
            
        </ul>
    </div>
    <hr>
</div>


            </div>

            <footer>
                <p>Michel Tu
                &mdash;
                <a href="mailto:michel@justonepixel.com">michel@justonepixel.com</a>
                &mdash;
                <a href="http://blog.justonepixel.com">http://blog.justonepixel.com</a></p>
            </footer>

        </div>
    </div>
    </div>
    <noscript id="deferred-styles">
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/bootstrap/css/bootstrap.2.2.2.min.css"/>
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/css/style.css?body=1"/>
    </noscript>
    <script>
      var loadDeferredStyles = function() {
        var addStylesNode = document.getElementById("deferred-styles");
        var replacement = document.createElement("div");
        replacement.innerHTML = addStylesNode.textContent;
        document.body.appendChild(replacement)
        addStylesNode.parentElement.removeChild(addStylesNode);
      };
      var raf = requestAnimationFrame || mozRequestAnimationFrame ||
          webkitRequestAnimationFrame || msRequestAnimationFrame;
      if (raf) raf(function() { window.setTimeout(loadDeferredStyles, 0); });
      else window.addEventListener('load', loadDeferredStyles);
    </script>
		
    </body>
</html>

