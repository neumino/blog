

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
        <title>Justonepixel.com - Replicate ReQL API in your own classes</title>
        
        <meta name="author" content="Michel">

        <!-- Enable responsive viewport -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/bootstrap/css/bootstrap.2.2.2.min.css"/>
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/css/style.css?body=1"/>

        <!-- atom & rss feed -->
        <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
        <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
    </head>

    <body>
    <div class="wrapper container">
    <div class="row">
        <div class="span1 offset1">
            <div class="navbar">
                <ul>
                    <li><a href="/"><img src="/assets/themes/justonepixel/img/home.png" /></a></li>
                    <li><a href="/about.html"><img src="/assets/themes/justonepixel/img/about.png" /></a></li>
                    <li><a href="/contact.html"><img src="/assets/themes/justonepixel/img/contact.png" /></a></li>
                    <li><a href="/archive.html"><img src="/assets/themes/justonepixel/img/archive.png" /></a></li>
                    <li><a href="/search.html"><img src="/assets/themes/justonepixel/img/search.png" /></a></li>
                    <li><a href="https://github.com/neumino"><img src="/assets/themes/justonepixel/img/github.png" /></a></li>
                    <li><a href="http://www.strava.com/athletes/1952902"><img src="/assets/themes/justonepixel/img/strava.png" /></a></li>
                    <li><a href="https://twitter.com/neumino"><img src="/assets/themes/justonepixel/img/twitter.png" /></a></li>
                    <li><a href="https://www.facebook.com/michel.tu"><img src="/assets/themes/justonepixel/img/facebook.png" /></a></li>
                    <li><a href="http://www.linkedin.com/in/tumichel"><img src="/assets/themes/justonepixel/img/linkedin.png" /></a></li>
                    <li><a href="https://plus.google.com/u/0/111745051853861893359/posts"><img src="/assets/themes/justonepixel/img/googleplus.png" /></a></li>
                </ul>
            </div>
        </div>

        <div class="span9">

            <div class="content">
                

<div class="post">
<i class="icon-post"></i>

    <h2>
        <a href="/geek/2015/02/04/replicate-reql-in-your-classes" class="title">Replicate ReQL API in your own classes</a>
        <span class="meta_info">posted on 04 February 2015</span>
    </h2>

    
<p>ReQL is embedded in the host language. If you use JavaScript,
you do not have to concatenate and escape SQL strings, or build JSON
objects with some special keys; your queries are plain JavaScript.</p>

<p>For example with <a href="https://github.com/neumino/rethinkdbdash">rethinkdbdash</a>,
updating all the users that are at least 18 years old with a field <code class="highlighter-rouge">isAdult</code>
set to <code class="highlighter-rouge">true</code> (in one round trip), can be written like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">'users'</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">user</span><span class="p">(</span><span class="s1">'age'</span><span class="p">).</span><span class="nx">gt</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
<span class="p">}).</span><span class="nx">update</span><span class="p">({</span> <span class="na">isAdult</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}).</span><span class="nx">run</span><span class="p">();</span>
</code></pre>
</div>

<p>RethinkDB ships with a data explorer where you can get test your queries.
Because ReQL is composed of chainable commands, the data explorer can provide
you with suggestions and auto-completion, making learning ReQL easy and fun.</p>

<h3 id="replicate-the-api">Replicate the API</h3>

<p>But this is not the only advantage of having an embedded chainable language;
you can import the query language in your own classes by just copying
the commands. This is what <a href="https://thinky.io">thinky</a> (a Node.js ORM)
does and this has multiple benefits:</p>

<ul>
  <li>It is easy to do and require very little work.</li>
  <li>Because the API is the same, the learning curve is a <a href="http://en.wikipedia.org/wiki/Heaviside_step_function">Heaviside step</a>.</li>
</ul>

<p>This article explains how to replicate ReQL API using rethinkdbdash. The same
operation can be done with the official driver or in another <em>flexible</em> language like Python, Ruby etc.
The only thing to know about rethinkdbdash, is that all commands return an instance of the class <code class="highlighter-rouge">Term</code>, and that
<code class="highlighter-rouge">Term</code> implements all the methods like <code class="highlighter-rouge">filter</code>, <code class="highlighter-rouge">get</code>, <code class="highlighter-rouge">update</code> etc.</p>

<p>Suppose that you have a class <code class="highlighter-rouge">User</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">User</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ecp</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">ecp</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// id of the emergency contact person</span>
<span class="p">};</span>
</code></pre>
</div>

<p>You can import all the methods in <code class="highlighter-rouge">User</code> by looping over all the keys
in <code class="highlighter-rouge">Term</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'rethinkdbdash'</span><span class="p">)();</span>
<span class="kd">var</span> <span class="nx">Term</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">expr</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">__proto__</span><span class="p">;</span>

<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">Term</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// this immediately invoked function is required</span>
    <span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)[</span><span class="nx">key</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">table</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">})(</span><span class="nx">key</span><span class="p">)</span><span class="nx">l</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now you can write:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">// Set the name of the user with id 1</span>
<span class="nx">Users</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">update</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="s2">"Michel"</span><span class="p">}).</span><span class="nx">run</span><span class="p">().</span><span class="nx">then</span><span class="p">(...).</span><span class="nx">error</span><span class="p">(...);</span>

<span class="c1">// Set all the users as "not verified"</span>
<span class="nx">Users</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="na">verified</span><span class="p">:</span> <span class="kc">false</span><span class="p">}).</span><span class="nx">run</span><span class="p">().</span><span class="nx">then</span><span class="p">(...).</span><span class="nx">error</span><span class="p">(...);</span>

<span class="c1">// Perform a simple join to retrieve the emergency contact person</span>
<span class="nx">Users</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">merge</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span> <span class="na">ecpPerson</span><span class="p">:</span> <span class="nx">Users</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">ecp</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}).</span><span class="nx">run</span><span class="p">().</span><span class="nx">then</span><span class="p">(...).</span><span class="nx">error</span><span class="p">(...);</span>
</code></pre>
</div>

<p>So if thinky is too cumbersome for your project (if you do
not need relations, hooks etc.) you can easily replicate the same API.</p>

<h3 id="define-your-own-reql-methods">Define your own ReQL methods</h3>

<p>You can also define methods on <code class="highlighter-rouge">Users</code> by simply adding them in <code class="highlighter-rouge">Users.prototype</code>, but
you can also create your own methods on the queries by wrapping the ReQL queries:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'rethinkdbdash'</span><span class="p">)();</span>
<span class="kd">var</span> <span class="nx">Term</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">expr</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">__proto__</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">Query</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_query</span> <span class="o">=</span> <span class="nx">query</span><span class="p">;</span> <span class="c1">// an instance of Term</span>
<span class="p">};</span>

<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">Term</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="s2">"run"</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Query</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// We want to return the promise returned by the ReQL query here</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_query</span><span class="p">.</span><span class="nx">run</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_query</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">Query</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Query</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_query</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_query</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)[</span><span class="nx">key</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">table</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})(</span><span class="nx">key</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>A few notes about this code:</p>

<ul>
  <li>You can copy all the methods on <code class="highlighter-rouge">Query.prototype</code> except <code class="highlighter-rouge">run</code> since for this
method you want to return the promise itself.</li>
  <li>Each method returns a new <code class="highlighter-rouge">Query</code> object to enable forking:</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">Adults</span> <span class="o">=</span> <span class="nx">Users</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">user</span><span class="p">(</span><span class="s2">"age"</span><span class="p">).</span><span class="nx">gt</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="p">});</span>
<span class="nx">Adults</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="na">isAdult</span><span class="p">:</span> <span class="kc">true</span><span class="p">}).</span><span class="nx">run</span><span class="p">().</span><span class="nx">then</span><span class="p">(...).</span><span class="nx">error</span><span class="p">(...);</span>
<span class="nx">Adults</span><span class="p">.</span><span class="nx">filter</span><span class="p">({</span><span class="na">location</span><span class="p">:</span> <span class="s2">"US"</span><span class="p">}).</span><span class="nx">run</span><span class="p">().</span><span class="nx">then</span><span class="p">(...).</span><span class="nx">error</span><span class="p">(...);</span>
</code></pre>
</div>

<p>This is it! You can now define your own methods:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">Query</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isAdult</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">Query</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_query</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">user</span><span class="p">(</span><span class="s2">"age"</span><span class="p">).</span><span class="nx">gt</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
  <span class="p">}));</span>
<span class="p">};</span>
<span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isAdult</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">table</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">'users'</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">Query</span><span class="p">(</span><span class="nx">table</span><span class="p">).</span><span class="nx">isAdult</span><span class="p">();</span>
<span class="p">};</span>

<span class="c1">// Retrieve all the adults</span>
<span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">Users</span><span class="p">.</span><span class="nx">filter</span><span class="p">({</span><span class="na">location</span><span class="p">:</span> <span class="s2">"UK"</span><span class="p">}).</span><span class="nx">isAdult</span><span class="p">().</span><span class="nx">run</span><span class="p">();</span>
</code></pre>
</div>

<p>Questions? Feedback? Shoot me a mail at <a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#111;&#114;&#112;&#104;&#101;&#101;&#064;&#103;&#109;&#097;&#105;&#108;&#046;&#099;&#111;&#109;">&#111;&#114;&#112;&#104;&#101;&#101;&#064;&#103;&#109;&#097;&#105;&#108;&#046;&#099;&#111;&#109;</a>
or ping me on Twitter <a href="https://twitter.com/neumino">@neumino</a></p>


    
    <ul class="tag_box inline">
        <li><i class="icon-folder-open"></i></li>
        
        


  
     
    	<li><a href="/categories.html#Geek-ref">
    		Geek <span>43</span>
    	</a></li>
    
  


    </ul>
      

    
    <ul class="tag_box inline">
        <li><i class="icon-tags"></i></li>
        
        


  
     
    	<li><a href="/tags.html#rethinkdb-ref">rethinkdb <span>21</span></a></li>
     
    	<li><a href="/tags.html#rethinkdbdash-ref">rethinkdbdash <span>5</span></a></li>
     
    	<li><a href="/tags.html#thinky-ref">thinky <span>8</span></a></li>
     
    	<li><a href="/tags.html#extend-ref">extend <span>1</span></a></li>
     
    	<li><a href="/tags.html#orm-ref">orm <span>3</span></a></li>
    
  



    </ul>
      

    
    <hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog.justonepixel.com -->
<ins class="adsbygoogle"
     style="display:inline-block;width:468px;height:60px"
     data-ad-client="ca-pub-5366199723595534"
     data-ad-slot="2620298801"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <hr>
    <div class="pagination">
        <ul>
            
            <li class="prev"><a href="/geek/2015/01/31/rethinkdbdash-nodejs-streams-and-implicit-run" title="Rethinkdbdash 1.16: Node.js streams, implicit run and more">&larr; Previous</a></li>
            
            <li><a href="/archive.html">Archive</a></li>
            
            <li class="next"><a href="/geek/2015/02/15/batch-operations-writable-streams" title="Batching operations in Node.js writable streams">Next &rarr;</a></li>
            
        </ul>
    </div>
    <hr>
</div>


            </div>

            <footer>
                <p>Michel Tu
                &mdash;
                <a href="mailto:michel@justonepixel.com">michel@justonepixel.com</a>
                &mdash;
                <a href="http://blog.justonepixel.com">http://blog.justonepixel.com</a></p>
            </footer>

        </div>
    </div>
    </div>
    <noscript id="deferred-styles">
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/bootstrap/css/bootstrap.2.2.2.min.css"/>
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/css/style.css?body=1"/>
    </noscript>
    <script>
      var loadDeferredStyles = function() {
        var addStylesNode = document.getElementById("deferred-styles");
        var replacement = document.createElement("div");
        replacement.innerHTML = addStylesNode.textContent;
        document.body.appendChild(replacement)
        addStylesNode.parentElement.removeChild(addStylesNode);
      };
      var raf = requestAnimationFrame || mozRequestAnimationFrame ||
          webkitRequestAnimationFrame || msRequestAnimationFrame;
      if (raf) raf(function() { window.setTimeout(loadDeferredStyles, 0); });
      else window.addEventListener('load', loadDeferredStyles);
    </script>
		
    </body>
</html>

