

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
        <title>Justonepixel.com - Rethinkdbdash and client side backtraces</title>
        
        <meta name="author" content="Michel">

        <!-- Enable responsive viewport -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/bootstrap/css/bootstrap.2.2.2.min.css"/>
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/css/style.css?body=1"/>

        <!-- atom & rss feed -->
        <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
        <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
    </head>

    <body>
    <div class="wrapper container">
    <div class="row">
        <div class="span1 offset1">
            <div class="navbar">
                <ul>
                    <li><a href="/"><img src="/assets/themes/justonepixel/img/home.png" /></a></li>
                    <li><a href="/about.html"><img src="/assets/themes/justonepixel/img/about.png" /></a></li>
                    <li><a href="/contact.html"><img src="/assets/themes/justonepixel/img/contact.png" /></a></li>
                    <li><a href="/archive.html"><img src="/assets/themes/justonepixel/img/archive.png" /></a></li>
                    <li><a href="/search.html"><img src="/assets/themes/justonepixel/img/search.png" /></a></li>
                    <li><a href="https://github.com/neumino"><img src="/assets/themes/justonepixel/img/github.png" /></a></li>
                    <li><a href="http://www.strava.com/athletes/1952902"><img src="/assets/themes/justonepixel/img/strava.png" /></a></li>
                    <li><a href="https://twitter.com/neumino"><img src="/assets/themes/justonepixel/img/twitter.png" /></a></li>
                    <li><a href="https://www.facebook.com/michel.tu"><img src="/assets/themes/justonepixel/img/facebook.png" /></a></li>
                    <li><a href="http://www.linkedin.com/in/tumichel"><img src="/assets/themes/justonepixel/img/linkedin.png" /></a></li>
                    <li><a href="https://plus.google.com/u/0/111745051853861893359/posts"><img src="/assets/themes/justonepixel/img/googleplus.png" /></a></li>
                </ul>
            </div>
        </div>

        <div class="span9">

            <div class="content">
                

<div class="post">
<i class="icon-post"></i>

    <h2>
        <a href="/geek/2015/08/15/rethinkdbdash-client-backtraces" class="title">Rethinkdbdash and client side backtraces</a>
        <span class="meta_info">posted on 15 August 2015</span>
    </h2>

    
<h3 id="a-bit-of-context">A bit of context</h3>

<p>I released rethinkdbdash 2.1.3 (and 2.1.4) a bit earlier today. This release besides adding
a few missing syntaxes for 2.1 (<code class="highlighter-rouge">r.union</code> and <code class="highlighter-rouge">condition.branch(...)</code>),
fixed an issue with the client-side backtraces, though to be honest, the client-side
backtraces were not really working before.</p>

<p>If a RethinkDB query throws an error, the server will provide a backtrace and the
driver will reconstruct the query and underline the broken part. For example
if a table is missing you will see this error:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">ReqlOpFailedError</span><span class="err">:</span> <span class="nx">Table</span> <span class="err">`</span><span class="nx">test</span><span class="p">.</span><span class="nx">users</span><span class="err">`</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">exist</span> <span class="k">in</span><span class="err">:</span>
<span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s2">"test"</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s2">"users"</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">var_1</span><span class="p">)</span> <span class="p">{</span>
<span class="o">^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>                         
    <span class="k">return</span> <span class="nx">var_1</span><span class="p">(</span><span class="s2">"age"</span><span class="p">).</span><span class="nx">gt</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
</div>

<p>The query is printed back and the broken parts are highlighted. These backtraces are in my
opinion of the little one of the little things that makes RethinkDB enjoyable to use.
However a few queries cannot be sent to the server and therefore no backtraces are available.
Because RethinkDB stores JSON document, some JavaScript values are forbidden, typically <code class="highlighter-rouge">NaN</code> and <code class="highlighter-rouge">Infinity</code>.
When the driver finds a forbidden value, it used to just throw an error saying <code class="highlighter-rouge">NaN cannot be converted to JSON</code>.
This is painful for two reasons:</p>

<ul>
  <li>The presence of <code class="highlighter-rouge">NaN</code> is an operational error and the driver should just reject the query, not throw.</li>
  <li><code class="highlighter-rouge">NaN</code> can easily propages and you basically have to inspect all possible variables. The bigger your
query, the harder debugging it is.</li>
</ul>

<h3 id="whats-new">Whatâ€™s new</h3>

<p>Since 2.1.3, Rethinkdbdash now builds backtraces for these errors and
will point exactly where the problem is.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'rethinkdbdash'</span><span class="p">)();</span>

<span class="kd">var</span> <span class="nx">ADULT_AGE</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">ADULT_AGE_US</span> <span class="o">=</span> <span class="kc">NaN</span><span class="p">;</span> <span class="c1">// oops</span>

<span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">'test'</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s1">'users'</span><span class="p">).</span><span class="nx">merge</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">branch</span><span class="p">(</span>
    <span class="nx">user</span><span class="p">(</span><span class="s1">'location'</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="s1">'US'</span><span class="p">),</span>
    <span class="p">{</span> <span class="na">canDrink</span><span class="p">:</span> <span class="nx">user</span><span class="p">(</span><span class="s1">'age'</span><span class="p">).</span><span class="nx">gt</span><span class="p">(</span><span class="nx">ADULT_AGE_US</span><span class="p">)</span> <span class="p">},</span>
    <span class="p">{</span> <span class="na">canDrink</span><span class="p">:</span> <span class="nx">user</span><span class="p">(</span><span class="s1">'age'</span><span class="p">).</span><span class="nx">gt</span><span class="p">(</span><span class="nx">ADULT_AGE</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">)</span>
<span class="p">}).</span><span class="nx">run</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">).</span><span class="nx">error</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
</div>

<p>What will be printed is:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">ReqlRuntimeError</span><span class="err">:</span> <span class="nx">Cannot</span> <span class="nx">convert</span> <span class="err">`</span><span class="kc">NaN</span><span class="err">`</span> <span class="nx">to</span> <span class="nx">JSON</span> <span class="k">in</span><span class="err">:</span>
<span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s2">"test"</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s2">"users"</span><span class="p">).</span><span class="nx">merge</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">var_1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">branch</span><span class="p">(</span><span class="nx">var_1</span><span class="p">(</span><span class="s2">"location"</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="s2">"US"</span><span class="p">),</span> <span class="p">{</span>
        <span class="na">canDrink</span><span class="p">:</span> <span class="nx">var_1</span><span class="p">(</span><span class="s2">"age"</span><span class="p">).</span><span class="nx">gt</span><span class="p">(</span><span class="kc">NaN</span><span class="p">)</span>
                                  <span class="o">^^^</span> 
    <span class="p">},</span> <span class="p">{</span>
        <span class="na">canDrink</span><span class="p">:</span> <span class="nx">var_1</span><span class="p">(</span><span class="s2">"age"</span><span class="p">).</span><span class="nx">gt</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre>
</div>

<p>Pretty cool uh? You can pin exactly where the <code class="highlighter-rouge">NaN</code> value is.</p>

<p>Feedback/suggestions? Ping me on Twitter via <a href="https://twitter.com/neumino">@neumino</a>
or shoot me an email at <a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#111;&#114;&#112;&#104;&#101;&#101;&#064;&#103;&#109;&#097;&#105;&#046;&#099;&#111;&#109;">orphee@gmail.com</a>.</p>


    
    <ul class="tag_box inline">
        <li><i class="icon-folder-open"></i></li>
        
        


  
     
    	<li><a href="/categories.html#Geek-ref">
    		Geek <span>43</span>
    	</a></li>
    
  


    </ul>
      

    
    <ul class="tag_box inline">
        <li><i class="icon-tags"></i></li>
        
        


  
     
    	<li><a href="/tags.html#thinky-ref">thinky <span>8</span></a></li>
     
    	<li><a href="/tags.html#relation-ref">relation <span>2</span></a></li>
     
    	<li><a href="/tags.html#rethinkdb-ref">rethinkdb <span>21</span></a></li>
    
  



    </ul>
      

    
    <hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog.justonepixel.com -->
<ins class="adsbygoogle"
     style="display:inline-block;width:468px;height:60px"
     data-ad-client="ca-pub-5366199723595534"
     data-ad-slot="2620298801"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <hr>
    <div class="pagination">
        <ul>
            
            <li class="prev"><a href="/geek/2015/08/13/thinky-relations" title="Thinky 2.1.1 - Updating only relations">&larr; Previous</a></li>
            
            <li><a href="/archive.html">Archive</a></li>
            
            <li class="next"><a href="/geek/2015/08/30/qualcomm-atheros-linux" title="Losing connectivity after a Chrome request">Next &rarr;</a></li>
            
        </ul>
    </div>
    <hr>
</div>


            </div>

            <footer>
                <p>Michel Tu
                &mdash;
                <a href="mailto:michel@justonepixel.com">michel@justonepixel.com</a>
                &mdash;
                <a href="http://blog.justonepixel.com">http://blog.justonepixel.com</a></p>
            </footer>

        </div>
    </div>
    </div>
    <noscript id="deferred-styles">
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/bootstrap/css/bootstrap.2.2.2.min.css"/>
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/css/style.css?body=1"/>
    </noscript>
    <script>
      var loadDeferredStyles = function() {
        var addStylesNode = document.getElementById("deferred-styles");
        var replacement = document.createElement("div");
        replacement.innerHTML = addStylesNode.textContent;
        document.body.appendChild(replacement)
        addStylesNode.parentElement.removeChild(addStylesNode);
      };
      var raf = requestAnimationFrame || mozRequestAnimationFrame ||
          webkitRequestAnimationFrame || msRequestAnimationFrame;
      if (raf) raf(function() { window.setTimeout(loadDeferredStyles, 0); });
      else window.addEventListener('load', loadDeferredStyles);
    </script>
		
    </body>
</html>

