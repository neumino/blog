

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
        <title>Justonepixel.com - Thinky 2.1.1 - Updating only relations</title>
        
        <meta name="author" content="Michel">

        <!-- Enable responsive viewport -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/bootstrap/css/bootstrap.2.2.2.min.css"/>
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/css/style.css?body=1"/>

        <!-- atom & rss feed -->
        <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
        <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
    </head>

    <body>
    <div class="wrapper container">
    <div class="row">
        <div class="span1 offset1">
            <div class="navbar">
                <ul>
                    <li><a href="/"><img src="/assets/themes/justonepixel/img/home.png" /></a></li>
                    <li><a href="/about.html"><img src="/assets/themes/justonepixel/img/about.png" /></a></li>
                    <li><a href="/contact.html"><img src="/assets/themes/justonepixel/img/contact.png" /></a></li>
                    <li><a href="/archive.html"><img src="/assets/themes/justonepixel/img/archive.png" /></a></li>
                    <li><a href="/search.html"><img src="/assets/themes/justonepixel/img/search.png" /></a></li>
                    <li><a href="https://github.com/neumino"><img src="/assets/themes/justonepixel/img/github.png" /></a></li>
                    <li><a href="http://www.strava.com/athletes/1952902"><img src="/assets/themes/justonepixel/img/strava.png" /></a></li>
                    <li><a href="https://twitter.com/neumino"><img src="/assets/themes/justonepixel/img/twitter.png" /></a></li>
                    <li><a href="https://www.facebook.com/michel.tu"><img src="/assets/themes/justonepixel/img/facebook.png" /></a></li>
                    <li><a href="http://www.linkedin.com/in/tumichel"><img src="/assets/themes/justonepixel/img/linkedin.png" /></a></li>
                    <li><a href="https://plus.google.com/u/0/111745051853861893359/posts"><img src="/assets/themes/justonepixel/img/googleplus.png" /></a></li>
                </ul>
            </div>
        </div>

        <div class="span9">

            <div class="content">
                

<div class="post">
<i class="icon-post"></i>

    <h2>
        <a href="/geek/2015/08/13/thinky-relations" class="title">Thinky 2.1.1 - Updating only relations</a>
        <span class="meta_info">posted on 13 August 2015</span>
    </h2>

    
<p>I released thinky 2.1.1 a bit earlier today.</p>

<p>Thinky was built on the assumption that you always retrieve all the documents from
the database because updating a relation. Typically this was the expected workflow.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">thinky</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'thinky'</span><span class="p">)();</span>
<span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">thinky</span><span class="p">.</span><span class="nx">type</span><span class="p">();</span>

<span class="nx">User</span> <span class="o">=</span> <span class="nx">thinky</span><span class="p">.</span><span class="nx">createModel</span><span class="p">(</span><span class="s2">"User"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">id</span><span class="p">:</span> <span class="nx">type</span><span class="p">.</span><span class="nx">string</span><span class="p">(),</span>
  <span class="na">email</span><span class="p">:</span> <span class="nx">type</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">required</span><span class="p">(),</span>
  <span class="na">name</span><span class="p">:</span> <span class="nx">type</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">required</span><span class="p">(),</span>
  <span class="na">adult</span><span class="p">:</span> <span class="nx">type</span><span class="p">.</span><span class="kr">boolean</span><span class="p">().</span><span class="k">default</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">User</span><span class="p">.</span><span class="nx">hasAndBelongsToMany</span><span class="p">(</span><span class="nx">User</span><span class="p">,</span> <span class="s2">"friends"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">);</span>

<span class="nx">User</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"3851d8b4-5358-43f2-ba23-f4d481358901"</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">getJoin</span><span class="p">({</span><span class="na">friends</span><span class="p">:</span> <span class="kc">true</span><span class="p">}).</span><span class="nx">run</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// user is fully defined with its friends</span>
  <span class="nx">user</span><span class="p">.</span><span class="nx">friends</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">return</span> <span class="nx">user</span><span class="p">.</span><span class="nx">saveAll</span><span class="p">({</span><span class="na">friends</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// user 3851d8b4-5358-43f2-ba23-f4d481358901 has no more friends!</span>
<span class="p">});</span>
</code></pre>
</div>

<p>Looking at the GitHub issue tracker, many developers had issues. Trying to
save a relation with pre-existing documents can throw errors like <a href="https://github.com/neumino/thinky/issues/245">#245</a>
and basically wasnâ€™t clear for many <a href="https://github.com/neumino/thinky/issues/309">#309</a>.
Thinky 2.1.1 takes a stab at all these problems and introduces two new commands:</p>

<div class="highlighter-rouge"><pre class="highlight"><code> - addRelation(field, joinedDocument)
 - removeRelation(field[, joinedDocument])
</code></pre>
</div>

<p>You can chain these commands on a query that returns one document and add/remove a relation.</p>

<p><em>Example:</em> Add a new friend</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">User</span><span class="p">.</span><span class="nx">hasAndBelongsToMany</span><span class="p">(</span><span class="nx">User</span><span class="p">,</span> <span class="s2">"friends"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">);</span>

<span class="nx">User</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"3851d8b4-5358-43f2-ba23-f4d481358901"</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">addRelation</span><span class="p">(</span><span class="s1">'friends'</span><span class="p">,</span> <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="s1">'0e4a6f6f-cc0c-4aa5-951a-fcfc480dd05a'</span><span class="p">})</span>
    <span class="p">.</span><span class="nx">run</span><span class="p">()</span>
</code></pre>
</div>

<p><em>Example:</em> Remove a new friend</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">User</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"3851d8b4-5358-43f2-ba23-f4d481358901"</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">removeRelation</span><span class="p">(</span><span class="s1">'friends'</span><span class="p">,</span> <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="s1">'0e4a6f6f-cc0c-4aa5-951a-fcfc480dd05a'</span><span class="p">})</span>
    <span class="p">.</span><span class="nx">run</span><span class="p">()</span>
</code></pre>
</div>

<p><em>Example:</em> Remove all friends</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">User</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"3851d8b4-5358-43f2-ba23-f4d481358901"</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">addRelation</span><span class="p">(</span><span class="s1">'friends'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">run</span><span class="p">()</span>
</code></pre>
</div>

<p>The second argument to <code class="highlighter-rouge">addRelation</code> needs to provide just enough information to create a relation.</p>

<ul>
  <li>In the case of a <code class="highlighter-rouge">hasOne</code> or <code class="highlighter-rouge">hasMany</code> relation, only the primary key is required.</li>
  <li>In the case of a <code class="highlighter-rouge">belongsTo</code> or <code class="highlighter-rouge">hasAndBelongsToMany</code> relation, the primary key or the right key is required - one is enough!</li>
</ul>

<p>The same argument for <code class="highlighter-rouge">removeRelation</code> is not always required and if it is defined, it also needs just enough information
to find the relation to delete.</p>

<ul>
  <li>For <code class="highlighter-rouge">hasOne</code> and <code class="highlighter-rouge">belongsTo</code> relations, the <code class="highlighter-rouge">joinedDocument</code> is not required and should not be provided.</li>
  <li>For <code class="highlighter-rouge">hasMany</code> and <code class="highlighter-rouge">hasAndBelongsToMany</code> relations, the absense of the <code class="highlighter-rouge">joinedDocument</code> makes the command
delete all the relations for the given document. If a document is provided, the primary key or the right key
is required - again, one of them is enough.</li>
</ul>

<p>This update should enable people easier to manipulate relations without the need to retrieve the documents
from the database. Beyond a simpler interface, it should also ease a little the load on the database.</p>

<p>Feedback/suggestions? Ping me on Twitter via <a href="https://twitter.com/neumino">@neumino</a>
or shoot me an email at <a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#111;&#114;&#112;&#104;&#101;&#101;&#064;&#103;&#109;&#097;&#105;&#046;&#099;&#111;&#109;">orphee@gmail.com</a>.</p>


    
    <ul class="tag_box inline">
        <li><i class="icon-folder-open"></i></li>
        
        


  
     
    	<li><a href="/categories.html#Geek-ref">
    		Geek <span>43</span>
    	</a></li>
    
  


    </ul>
      

    
    <ul class="tag_box inline">
        <li><i class="icon-tags"></i></li>
        
        


  
     
    	<li><a href="/tags.html#thinky-ref">thinky <span>8</span></a></li>
     
    	<li><a href="/tags.html#relation-ref">relation <span>2</span></a></li>
     
    	<li><a href="/tags.html#rethinkdb-ref">rethinkdb <span>21</span></a></li>
    
  



    </ul>
      

    
    <hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog.justonepixel.com -->
<ins class="adsbygoogle"
     style="display:inline-block;width:468px;height:60px"
     data-ad-client="ca-pub-5366199723595534"
     data-ad-slot="2620298801"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <hr>
    <div class="pagination">
        <ul>
            
            <li class="prev"><a href="/geek/2015/06/29/rethinkdbdash-bug-103" title="Rethinkdbdash bug #103">&larr; Previous</a></li>
            
            <li><a href="/archive.html">Archive</a></li>
            
            <li class="next"><a href="/geek/2015/08/15/rethinkdbdash-client-backtraces" title="Rethinkdbdash and client side backtraces">Next &rarr;</a></li>
            
        </ul>
    </div>
    <hr>
</div>


            </div>

            <footer>
                <p>Michel Tu
                &mdash;
                <a href="mailto:michel@justonepixel.com">michel@justonepixel.com</a>
                &mdash;
                <a href="http://blog.justonepixel.com">http://blog.justonepixel.com</a></p>
            </footer>

        </div>
    </div>
    </div>
    <noscript id="deferred-styles">
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/bootstrap/css/bootstrap.2.2.2.min.css"/>
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/css/style.css?body=1"/>
    </noscript>
    <script>
      var loadDeferredStyles = function() {
        var addStylesNode = document.getElementById("deferred-styles");
        var replacement = document.createElement("div");
        replacement.innerHTML = addStylesNode.textContent;
        document.body.appendChild(replacement)
        addStylesNode.parentElement.removeChild(addStylesNode);
      };
      var raf = requestAnimationFrame || mozRequestAnimationFrame ||
          webkitRequestAnimationFrame || msRequestAnimationFrame;
      if (raf) raf(function() { window.setTimeout(loadDeferredStyles, 0); });
      else window.addEventListener('load', loadDeferredStyles);
    </script>
		
    </body>
</html>

