

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
        <title>Justonepixel.com - Certificates for GRPC with TLS</title>
        
        <meta name="author" content="Michel">

        <!-- Enable responsive viewport -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/bootstrap/css/bootstrap.2.2.2.min.css"/>
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/css/style.css?body=1"/>

        <!-- atom & rss feed -->
        <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
        <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
    </head>

    <body>
    <div class="wrapper container">
    <div class="row">
        <div class="span1 offset1">
            <div class="navbar">
                <ul>
                    <li><a href="/"><img src="/assets/themes/justonepixel/img/home.png" /></a></li>
                    <li><a href="/about.html"><img src="/assets/themes/justonepixel/img/about.png" /></a></li>
                    <li><a href="/contact.html"><img src="/assets/themes/justonepixel/img/contact.png" /></a></li>
                    <li><a href="/archive.html"><img src="/assets/themes/justonepixel/img/archive.png" /></a></li>
                    <li><a href="/search.html"><img src="/assets/themes/justonepixel/img/search.png" /></a></li>
                    <li><a href="https://github.com/neumino"><img src="/assets/themes/justonepixel/img/github.png" /></a></li>
                    <li><a href="http://www.strava.com/athletes/1952902"><img src="/assets/themes/justonepixel/img/strava.png" /></a></li>
                    <li><a href="https://twitter.com/neumino"><img src="/assets/themes/justonepixel/img/twitter.png" /></a></li>
                    <li><a href="https://www.facebook.com/michel.tu"><img src="/assets/themes/justonepixel/img/facebook.png" /></a></li>
                    <li><a href="http://www.linkedin.com/in/tumichel"><img src="/assets/themes/justonepixel/img/linkedin.png" /></a></li>
                    <li><a href="https://plus.google.com/u/0/111745051853861893359/posts"><img src="/assets/themes/justonepixel/img/googleplus.png" /></a></li>
                </ul>
            </div>
        </div>

        <div class="span9">

            <div class="content">
                

<div class="post">
<i class="icon-post"></i>

    <h2>
        <a href="/geek/2016/03/20/grpc-certificate" class="title">Certificates for GRPC with TLS</a>
        <span class="meta_info">posted on 20 March 2016</span>
    </h2>

    
<p>I haven’t blogged anything for the past few months because I have been busy
working on a few projects using new shiny toys. One of them is <a href="https://www.grpc.io">gRPC</a>, a high
performance, open source, general RPC framework, which is based on Google’s
internal Stubby RPC system.</p>

<p>This post is mostly about using TLS with gRPC in Golang, but if you are wondering
what gRPC brings that HTTP/JSON does not, here are a few reasons on top of my head:</p>

<ul>
  <li>Better performance in respect to network compression, serialization etc.</li>
  <li>Structured RPC.</li>
  <li>Error tracing.</li>
</ul>

<p>Anyway, if you want to use TLS with gRPC, you need to create a few certificates first.
This script does it for you. Usage is <code class="highlighter-rouge">gen.sh &lt;host&gt; &lt;prefix&gt;</code> where <code class="highlighter-rouge">host</code> is the <code class="highlighter-rouge">host</code>
on which your gRPC server is listening. The parameter <code class="highlighter-rouge">prefix</code> is just used to prefix the
output files such that you can create prod and dev certificates.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nv">PASSWORD</span><span class="o">=</span><span class="sb">`</span>cat /dev/urandom | tr -dc <span class="s1">'a-zA-Z0-9'</span> | fold -w 32 | head -n 1<span class="sb">`</span>
<span class="nv">HOST</span><span class="o">=</span><span class="nv">$1</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="nv">$HOST</span> <span class="o">]</span>; <span class="k">then </span><span class="nv">HOST</span><span class="o">=</span><span class="s2">"localhost"</span>; <span class="k">fi
</span><span class="nv">PREFIX</span><span class="o">=</span><span class="nv">$2</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="nv">$PREFIX</span> <span class="o">]</span>; <span class="k">then </span><span class="nv">PREFIX</span><span class="o">=</span><span class="s2">"dev"</span>; <span class="k">fi

</span>openssl genrsa -passout pass:<span class="nv">$PASSWORD</span> -des3 -out <span class="nv">$PREFIX</span><span class="s1">'server.key'</span> 4096
openssl req -passin pass:<span class="nv">$PASSWORD</span> -new -x509 -days 3650 -key <span class="nv">$PREFIX</span><span class="s1">'server.key'</span> -out <span class="nv">$PREFIX</span><span class="s1">'server.crt'</span> -subj <span class="s1">'/C=US/ST=CA/L=Sunnyvale/O=MyApp/CN='</span><span class="nv">$HOST</span><span class="s1">'/emailAddress=foo@bar.com'</span>
openssl rsa -passin pass:<span class="nv">$PASSWORD</span> -in <span class="nv">$PREFIX</span><span class="s1">'server.key'</span> -out <span class="nv">$PREFIX</span><span class="s1">'server.key'</span>
</code></pre>
</div>

<p>Two files are created, a <code class="highlighter-rouge">.crt</code> and <code class="highlighter-rouge">.key</code> one. You can then create create a connection with:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">creds</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">credentials</span><span class="o">.</span><span class="n">NewClientTLSFromFile</span><span class="p">(</span><span class="n">grpcCrtFile</span><span class="p">,</span><span class="x"> </span><span class="n">host</span><span class="p">)</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
  </span><span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Failed to create TLS credentials %v"</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span><span class="n">opts</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">grpc</span><span class="o">.</span><span class="n">WithTransportCredentials</span><span class="p">(</span><span class="n">creds</span><span class="p">)</span><span class="x">
</span><span class="n">connection</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">grpc</span><span class="o">.</span><span class="n">Dial</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">address</span><span class="p">,</span><span class="x"> </span><span class="n">g</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span><span class="x">
</span></code></pre>
</div>

<p>Create your server with:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">lis</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">net</span><span class="o">.</span><span class="n">Listen</span><span class="p">(</span><span class="s">"tcp"</span><span class="p">,</span><span class="x"> </span><span class="o">*</span><span class="n">grpcHost</span><span class="o">+</span><span class="s">":"</span><span class="o">+</span><span class="n">strconv</span><span class="o">.</span><span class="n">Itoa</span><span class="p">(</span><span class="o">*</span><span class="n">grpcPort</span><span class="p">))</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
  </span><span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"failed to listen: %v"</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">creds</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">credentials</span><span class="o">.</span><span class="n">NewServerTLSFromFile</span><span class="p">(</span><span class="n">grpcCrtFile</span><span class="p">,</span><span class="x"> </span><span class="n">grpcKeyFile</span><span class="p">)</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
  </span><span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Failed to generate credentials %v"</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">s</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">grpc</span><span class="o">.</span><span class="n">NewServer</span><span class="p">(</span><span class="n">grpc</span><span class="o">.</span><span class="n">Creds</span><span class="p">(</span><span class="n">creds</span><span class="p">))</span><span class="x">
</span><span class="c">// Register your services here</span><span class="x">
</span><span class="n">s</span><span class="o">.</span><span class="n">Serve</span><span class="p">(</span><span class="n">lis</span><span class="p">)</span><span class="x">
</span></code></pre>
</div>


    
    <ul class="tag_box inline">
        <li><i class="icon-folder-open"></i></li>
        
        


  
     
    	<li><a href="/categories.html#Geek-ref">
    		Geek <span>43</span>
    	</a></li>
    
  


    </ul>
      

    
    <ul class="tag_box inline">
        <li><i class="icon-tags"></i></li>
        
        


  
     
    	<li><a href="/tags.html#grpc-ref">grpc <span>1</span></a></li>
     
    	<li><a href="/tags.html#certificate-ref">certificate <span>1</span></a></li>
    
  



    </ul>
      

    
    <hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog.justonepixel.com -->
<ins class="adsbygoogle"
     style="display:inline-block;width:468px;height:60px"
     data-ad-client="ca-pub-5366199723595534"
     data-ad-slot="2620298801"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <hr>
    <div class="pagination">
        <ul>
            
            <li class="prev"><a href="/geek/2015/12/02/travis-container" title="Using Travis'container architecture">&larr; Previous</a></li>
            
            <li><a href="/archive.html">Archive</a></li>
            
            <li class="next"><a href="/geek/2016/05/21/light-dm-multiple-monitors" title="Lightdm on a specific monitor">Next &rarr;</a></li>
            
        </ul>
    </div>
    <hr>
</div>


            </div>

            <footer>
                <p>Michel Tu
                &mdash;
                <a href="mailto:michel@justonepixel.com">michel@justonepixel.com</a>
                &mdash;
                <a href="http://blog.justonepixel.com">http://blog.justonepixel.com</a></p>
            </footer>

        </div>
    </div>
    </div>
    <noscript id="deferred-styles">
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/bootstrap/css/bootstrap.2.2.2.min.css"/>
      <link rel="stylesheet" type="text/css" href="/assets/themes/justonepixel/css/style.css?body=1"/>
    </noscript>
    <script>
      var loadDeferredStyles = function() {
        var addStylesNode = document.getElementById("deferred-styles");
        var replacement = document.createElement("div");
        replacement.innerHTML = addStylesNode.textContent;
        document.body.appendChild(replacement)
        addStylesNode.parentElement.removeChild(addStylesNode);
      };
      var raf = requestAnimationFrame || mozRequestAnimationFrame ||
          webkitRequestAnimationFrame || msRequestAnimationFrame;
      if (raf) raf(function() { window.setTimeout(loadDeferredStyles, 0); });
      else window.addEventListener('load', loadDeferredStyles);
    </script>
		
    </body>
</html>

